<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
	<head>
        <title>three.js Geometry Maker</title>
        <script src="three.min.js"></script>
        <script src="OrbitControls.js"></script>
        <script src='DragControls.js'></script>
        <script src='stats.js'></script>
    </head>

    <body style="margin:0px; width:100%; height: 100%">

        <script>
            var scene = new THREE.Scene();
            scene.background = new THREE.Color(0xaaaaaa);

            var stats = new Stats();
            stats.dom.style.removeProperty('top');
            stats.dom.style.bottom = "0px";
            document.body.appendChild(stats.dom);

            var renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio(window.devicePixelRatio);
            var style = renderer.domElement.style;
            style.zIndex = 0;
            style.position = "fixed";
            style.left = 0;
            style.top = 0;
            document.body.appendChild(renderer.domElement);

            var camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight);
            camera.position.set(0, 0, 30);

            var forward = new THREE.Vector3();

            var planeDistance = 30;

            var geometryGroup = new THREE.Group();
            scene.add(geometryGroup);

            var currentPoint = new THREE.Mesh(
                new THREE.SphereBufferGeometry(),
                new THREE.MeshNormalMaterial({
                    opacity : 0.5,
                    transparent : true
                })
            )
            currentPoint.userData.uv = new THREE.Vector2();
            currentPoint.userData.normal = new THREE.Vector3();
            scene.add(currentPoint);

            var mouse = new THREE.Vector2();
            var ray = new THREE.Ray()
            window.addEventListener('mousemove', function(e)
            {
                if(currentMode != 'add'){return;}

                mouse.set(
                    (e.clientX / window.innerWidth) * 2 - 1,
                    -(e.clientY / window.innerHeight) * 2 + 1
                )

                ray.origin.setFromMatrixPosition(camera.matrixWorld);
                ray.direction.set(mouse.x, mouse.y, 0.5).unproject(camera).sub(ray.origin).normalize();

                ray.direction.multiplyScalar(planeDistance);

                forward.copy(ray.origin).add(ray.direction);
               
                currentPoint.position.copy(forward);
                sync();
            })

            var controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enabled = false;

            var objects = [];
            var selectedObject;
            var drag = new THREE.DragControls(objects, camera, renderer.domElement);
            drag.addEventListener('dragstart', function(e)
            {
                if(currentMode == 'delete')
                {
                    e.object.parent.remove(e.object);
                    return;
                }
                selectedObject = e.object;
                sync();
            });
            drag.addEventListener('drag', sync);
            drag.addEventListener('dragend', sync);
            drag.deactivate();

            var modes = ['camera', 'drag', 'add', 'delete'];
            var currentMode = 'add';

            window.addEventListener('keydown', function(e)
            {
                if(e.repeat){return;}

                if(e.key == "F1")
                {
                    currentMode = 'add';
                }
                else if(e.key == "F2")
                {
                    currentMode = 'drag';
                }
                else if(e.key == '`')
                {
                    currentMode = 'camera';
                }
                else if(e.key == 'Delete')
                {
                    currentMode = 'delete';
                }
                else {return;}

                controls.enabled = currentMode == 'camera';
                (currentMode == 'drag' || currentMode == 'delete') ? drag.activate() : drag.deactivate();
                document.getElementById('modeLabel').innerText = currentMode;
                currentPoint.visible = currentMode == 'add';
            })

            function resize()
            {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            function render()
            {
                window.requestAnimationFrame(render);

                stats.begin();
                renderer.render(scene, camera);
                stats.end();
            }
            render();

            var keys = ['x', 'y', 'z']
            function updatePosition(id)
            {
                var parent = document.getElementById(id);
                for(var key of keys)
                {
                    var inputs = document.getElementsByClassName(key);
                    for(var input of inputs)
                    {
                        if(input.parentNode === parent)
                        {
                            var tab = currentPoint[id] || currentPoint.userData[id];
                            tab[key] = parseFloat(input.value);
                            break;
                        }
                    }
                }
                sync(true);
            }

            function draw()
            {
                var context = this.context;
                context.fillStyle = 'black';
                context.fillRect(0, 0, 64, 64);
                context.fillStyle = 'white';
                context.font = "Arial 28px";
                context.textBaseline = "top";
                context.textAlign = "left";

                var uv = this.userData.uv;
                var text = "uv: " + uv.x.toFixed(2) + ", " + uv.y.toFixed(2);
                context.fillText(text, 0, 0, 64);

                var normal = this.userData.normal;
                text = "normal: " + normal.x.toFixed(2) + ", " + normal.y.toFixed(2) + "," + normal.z.toFixed(2);
                context.fillText(text, 0, 32, 64);
                this.material.map.needsUpdate = true;
            }

            function addPlane(parent)
            {
                var canvas = document.createElement("canvas", {alpha : false});
                canvas.width = canvas.height = 64;

                var mesh = new THREE.Sprite(
                    new THREE.SpriteMaterial({
                        map : new THREE.CanvasTexture(canvas),
                    })
                );
                mesh.userData = parent.userData;
                mesh.context = canvas.getContext('2d');

                mesh.position.y = 2;
                parent.add(mesh);

                parent.material.opacity = 1;
                parent.material.transparent = false;

                parent.updatePlane = draw.bind(mesh);
                parent.updatePlane();
                return parent;
            }

            function addVertex()
            {
                geometryGroup.add(addPlane(currentPoint.clone()));
            }

            function normalizeNormalVector()
            {
                var target = currentMode == 'add' ? currentPoint : selectedObject;
                if(!target){return;}

                var normal = target.userData.normal;
                if(normal.normalize)
                {
                    normal.normalize();
                }
                else
                {
                    var length = Math.sqrt(normal.x * normal.x + normal.y * normal.y + normal.z * normal.z);
                    normal.x /= length;
                    normal.y /= length;
                    normal.z /= length;
                }
                sync();
            }

            var syncArgs = ['position', 'uv', 'normal'];
            function sync(targetToSource)
            {
                targetToSource = targetToSource === true;

                var target = currentMode == 'add' ? currentPoint : selectedObject;
                if(!target){return;}

                for(var id of syncArgs)
                {
                    var parent = document.getElementById(id);
                    for(var key of keys)
                    {
                        var inputs = document.getElementsByClassName(key);
                        for(var input of inputs)
                        {
                            if(input.parentNode === parent)
                            {
                                var tab = target[id] || target.userData[id];
                                if(targetToSource)
                                {
                                    tab[key] = parseFloat(input.value);
                                }
                                else
                                {
                                    input.value = tab[key];
                                }
                                break;
                            }
                        }
                    }
                }
                if(targetToSource && target.updatePlane)
                {
                    target.updatePlane();
                }
            }
            window.addEventListener('load', function(){sync();});

            function insertObj(obj)
            {
                if(obj.isMesh)
                {
                    objects.push(obj);
                }
            }

            window.addEventListener('click', function(e)
            {
                if(currentMode != 'add'){return;}

                normalizeNormalVector();
                addVertex();
                objects.length = 0;
                geometryGroup.traverse(insertObj);
            });

            window.oncontextmenu = function(e)
            {
                return false;
            };

            var link = document.createElement('a');
            link.style.display = 'none';
            document.body.appendChild(link);
            function saveGeometry()
            {
                var str = JSON.stringify(geometryGroup.toJSON());
                str = str.replace( /[\n\t]+([\d\.e\-\[\]]+)/g, '$1' );

                link.href = URL.createObjectURL(new Blob([str], {type : 'text/plain'}));
                link.download = 'geometry.json';
                link.click();
            }

            var loader = new THREE.ObjectLoader();
            function loadJSON(textarea)
            {
                var text = textarea.value;
                if(!text){return;}

                var obj = loader.parse(JSON.parse(text));
                geometryGroup.parent.remove(geometryGroup);
                geometryGroup = obj;
                scene.add(geometryGroup);
            }

            window.addEventListener('load', function()
            {
                var textarea = document.getElementById("jsonCode");
                textarea.addEventListener('dragover', function(evt)
                {
                    evt.stopPropagation();
                    evt.preventDefault();
                    evt.dataTransfer.dropEffect = 'copy';
                }, false);
                textarea.addEventListener('drop', function(evt)
                {
                    evt.stopPropagation();
                    evt.preventDefault();

                    var files = evt.dataTransfer.files;
                    var reader = new FileReader();
                    reader.onload = function(event){
                        textarea.value = event.target.result;
                    }
                    reader.readAsText(files[0], "UTF-8");
                }, false);
            })

            function clearGeometry()
            {
                geometryGroup.children = [];
            }

        </script>

        <div id='Current Vertex' style='z-index: 1; background : silver; padding:5px; position:fixed; top:0; right:0; overflow:auto;'>
            <label>Mode: </label><label id='modeLabel'>add</label><br>

            <h2>Current Vertex</h2>

            <h3>Position</h3>
            <div id="position">
                <label for="x">X</label>
                <input type='number' step='any' class='x' value='0' onchange="updatePosition('position')">
                <label for="x">Y</label>
                <input type='number' step='any' class='y' value='0' onchange="updatePosition('position')">
                <label for="x">Z</label>
                <input type='number' step='any' class='z' value='0' onchange="updatePosition('position')">
            </div>
            
            <h3>UV</h3>
            <div id="uv">
                <label for="x">X</label>
                <input type='number' step='any' class='x' value='0' onchange="updatePosition('uv')">
                <label for="x">Y</label>
                <input type='number' step='any' class='y' value='0' onchange="updatePosition('uv')">
            </div>

            <h3>Normal</h3>
            <div id="normal">
                <label for="x">X</label>
                <input type='number' step='any' class='x' value='0' onchange="updatePosition('normal')">
                <label for="x">Y</label>
                <input type='number' step='any' class='y' value='0' onchange="updatePosition('normal')">
                <label for="x">Z</label>
                <input type='number' step='any' class='z' value='0' onchange="updatePosition('normal')">
                <button type='button' onclick='normalizeNormalVector()'>Normalize</button>
            </div>

            <button type='button' onclick='saveGeometry()'>Save Scene</button><br>
            <div>
                <textarea id='jsonCode' rows="4" cols="50" placeholder="Enter JSON code to load"></textarea>
                <button type='button' onclick="loadJSON(document.getElementById('jsonCode'))">Load JSON</button>
            </div><br>
            <button type='button' onclick="clearGeometry()">Clear</button><br>
        </div>
    </body>
</html>